<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solano County QR Campaign Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    h1 {
      font-size: 32px;
      color: #1a202c;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #718096;
      font-size: 16px;
    }
    
    .auto-refresh-badge {
      display: inline-block;
      background: #48bb78;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 12px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .filters {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .filter-group label {
      display: block;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    select, input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .date-range-shortcuts {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .date-shortcut {
      padding: 6px 12px;
      background: #edf2f7;
      border: 2px solid transparent;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .date-shortcut:hover {
      background: #e2e8f0;
    }
    
    .date-shortcut.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .metric-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      border-left: 4px solid #667eea;
    }
    
    .metric-card.green { border-left-color: #48bb78; }
    .metric-card.blue { border-left-color: #4299e1; }
    .metric-card.orange { border-left-color: #ed8936; }
    
    .metric-label {
      color: #718096;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-value {
      font-size: 36px;
      font-weight: bold;
      color: #1a202c;
      margin-top: 8px;
    }
    
    .metric-sub {
      font-size: 12px;
      color: #a0aec0;
      margin-top: 4px;
    }
    
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .chart-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: bold;
      color: #1a202c;
      margin-bottom: 16px;
    }
    
    .city-list {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .city-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f7fafc;
    }
    
    .city-item:last-child { border-bottom: none; }
    
    .city-rank {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #edf2f7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #667eea;
      margin-right: 16px;
    }
    
    .city-name {
      flex: 1;
      font-weight: 600;
      color: #2d3748;
    }
    
    .city-count {
      font-weight: bold;
      color: #1a202c;
      margin-right: 12px;
    }
    
    .city-bar {
      width: 100px;
      height: 8px;
      background: #edf2f7;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .city-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.5s;
    }
    
    .buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #718096;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4a5568;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    .error {
      background: #fed7d7;
      color: #c53030;
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .success-badge {
      background: #c6f6d5;
      border: 2px solid #48bb78;
      color: #22543d;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 12px;
      display: inline-block;
    }
    
    @media (max-width: 768px) {
      .charts {
        grid-template-columns: 1fr;
      }
      h1 { font-size: 24px; }
      .filter-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="loading" id="loading">
      üîÑ Loading dashboard data...
    </div>
    
    <div id="dashboard" style="display: none;">
      <!-- Header -->
      <div class="header">
        <h1>üåâ Solano County QR Campaign Dashboard
          <span class="auto-refresh-badge" id="autoRefreshBadge">üîÑ Auto-refresh: ON</span>
        </h1>
        <p class="subtitle">Real-Time Analytics & Insights | Last updated: <span id="lastUpdated">--</span></p>
        <div class="buttons">
          <button class="btn-primary" onclick="refreshData()">üîÑ Refresh Now</button>
          <button class="btn-secondary" onclick="clearFilters()">‚úñ Clear Filters</button>
          <button class="btn-secondary" onclick="toggleAutoRefresh()">
            <span id="autoRefreshBtn">‚è∏Ô∏è Pause Auto-Refresh</span>
          </button>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="filters">
        <h3 style="margin-bottom: 12px; color: #2d3748;">üîç Filters</h3>
        
        <!-- Date Range Filter -->
        <div class="filter-group" style="margin-bottom: 16px;">
          <label>üìÖ Date Range</label>
          <div class="date-range-shortcuts">
            <div class="date-shortcut active" onclick="setDateRange('all')" id="date-all">All Time</div>
            <div class="date-shortcut" onclick="setDateRange('today')" id="date-today">Today</div>
            <div class="date-shortcut" onclick="setDateRange('7days')" id="date-7days">Last 7 Days</div>
            <div class="date-shortcut" onclick="setDateRange('30days')" id="date-30days">Last 30 Days</div>
            <div class="date-shortcut" onclick="setDateRange('custom')" id="date-custom">Custom Range</div>
          </div>
          <div id="customDateInputs" style="display: none; margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="font-size: 12px; color: #718096;">From:</label>
              <input type="date" id="dateFrom" onchange="applyCustomDateRange()">
            </div>
            <div>
              <label style="font-size: 12px; color: #718096;">To:</label>
              <input type="date" id="dateTo" onchange="applyCustomDateRange()">
            </div>
          </div>
        </div>
        
        <div class="filter-grid">
          <div class="filter-group">
            <label>üèôÔ∏è City</label>
            <select id="cityFilter" onchange="applyFilters()">
              <option value="all">All Cities</option>
            </select>
          </div>
          <div class="filter-group">
            <label>üì± QR Code</label>
            <select id="qrFilter" onchange="applyFilters()">
              <option value="all">All QR Codes</option>
            </select>
          </div>
          <div class="filter-group">
            <label>üíª Device</label>
            <select id="deviceFilter" onchange="applyFilters()">
              <option value="all">All Devices</option>
              <option value="Mobile">Mobile</option>
              <option value="Desktop">Desktop</option>
            </select>
          </div>
          <div class="filter-group">
            <label>üîÑ Duplicates</label>
            <select id="duplicateFilter" onchange="applyFilters()">
              <option value="hide">Hide Duplicates</option>
              <option value="show">Show All</option>
              <option value="only">Only Duplicates</option>
            </select>
          </div>
        </div>
        
        <div class="success-badge" id="filterStatus" style="display: none;">
          ‚úÖ Showing <strong id="filteredCount">0</strong> of <strong id="totalCount">0</strong> scans
        </div>
      </div>
      
      <!-- Metrics -->
      <div class="metrics">
        <div class="metric-card">
          <div class="metric-label">Total Scans</div>
          <div class="metric-value" id="totalScans">0</div>
        </div>
        <div class="metric-card green">
          <div class="metric-label">Unique Scans</div>
          <div class="metric-value" id="uniqueScans">0</div>
          <div class="metric-sub" id="uniquePercent">0% of total</div>
        </div>
        <div class="metric-card blue">
          <div class="metric-label">Mobile Scans</div>
          <div class="metric-value" id="mobileScans">0</div>
          <div class="metric-sub" id="mobilePercent">0% of total</div>
        </div>
        <div class="metric-card orange">
          <div class="metric-label">Duplicates</div>
          <div class="metric-value" id="duplicateScans">0</div>
          <div class="metric-sub" id="duplicatePercent">0% of total</div>
        </div>
      </div>
      
      <!-- Charts -->
      <div class="charts">
        <div class="chart-card">
          <div class="chart-title">üìä QR Code Performance</div>
          <canvas id="qrChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">üì± Device Distribution</div>
          <canvas id="deviceChart"></canvas>
        </div>
      </div>
      
      <!-- City Rankings -->
      <div class="city-list">
        <div class="chart-title">üìç Top Cities</div>
        <div id="cityList"></div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwXiVjdZUW2oYelONBYBDx9cESfdo1Zg50iDpSGjye7clfIEJoJn3QsM9qLiy-ZRi1L/exec';
    const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes in milliseconds
    
    // QR Code Name Mapping
    const QR_NAMES = {
      'qr1': 'Page 1 - Single QR',
      'qr2': 'Page 2 - QR #1',
      'qr3': 'Page 2 - QR #2',
      'qr4': 'Page 2 - QR #3'
    };
    
    let allData = [];
    let filteredData = [];
    let qrChart, deviceChart;
    let autoRefreshEnabled = true;
    let autoRefreshTimer = null;
    let currentDateRange = 'all';
    let customDateFrom = null;
    let customDateTo = null;
    
    // Load data from Google Sheet
    async function loadData() {
      try {
        const response = await fetch(SHEET_URL);
        const data = await response.json();
        
        // Transform data to match expected format
        allData = data.map(row => ({
          date: row.Timestamp || row.timestamp || '',
          city: row.City || row.city || '',
          qr: (row['QR Code'] || row.qrCode || '').toLowerCase(),
          qrName: QR_NAMES[(row['QR Code'] || row.qrCode || '').toLowerCase()] || (row['QR Code'] || row.qrCode || ''),
          device: row.Device || row.device || '',
          duplicate: row['Duplicate?'] || row.duplicate || 'No'
        }));
        
        // Populate filters
        populateCityFilter();
        populateQRFilter();
        
        // Update last updated time
        updateLastUpdatedTime();
        
        applyFilters();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
        // Start auto-refresh if enabled
        if (autoRefreshEnabled) {
          startAutoRefresh();
        }
        
      } catch (error) {
        document.getElementById('loading').innerHTML = 
          `<div class="error">‚ùå Error loading data: ${error.message}<br><br>
          Make sure your Google Apps Script is deployed and accessible!</div>`;
      }
    }
    
    function populateCityFilter() {
      const cities = [...new Set(allData.map(d => d.city))].filter(c => c).sort();
      const cityFilter = document.getElementById('cityFilter');
      // Clear existing options except "All Cities"
      cityFilter.innerHTML = '<option value="all">All Cities</option>';
      cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        cityFilter.appendChild(option);
      });
    }
    
    function populateQRFilter() {
      const qrCodes = [...new Set(allData.map(d => d.qr))].filter(q => q).sort();
      const qrFilter = document.getElementById('qrFilter');
      // Clear existing options except "All QR Codes"
      qrFilter.innerHTML = '<option value="all">All QR Codes</option>';
      qrCodes.forEach(qr => {
        const option = document.createElement('option');
        option.value = qr;
        option.textContent = QR_NAMES[qr] || qr.toUpperCase();
        qrFilter.appendChild(option);
      });
    }
    
    function updateLastUpdatedTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('lastUpdated').textContent = timeString;
    }
    
    // Date Range Functions
    function setDateRange(range) {
      currentDateRange = range;
      
      // Update active button
      document.querySelectorAll('.date-shortcut').forEach(btn => btn.classList.remove('active'));
      document.getElementById('date-' + range).classList.add('active');
      
      // Show/hide custom date inputs
      document.getElementById('customDateInputs').style.display = 
        range === 'custom' ? 'grid' : 'none';
      
      applyFilters();
    }
    
    function applyCustomDateRange() {
      customDateFrom = document.getElementById('dateFrom').value;
      customDateTo = document.getElementById('dateTo').value;
      applyFilters();
    }
    
    function filterByDateRange(item) {
      if (!item.date) return true;
      
      const itemDate = new Date(item.date);
      const now = new Date();
      
      switch(currentDateRange) {
        case 'all':
          return true;
        case 'today':
          const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          return itemDate >= todayStart;
        case '7days':
          const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
          return itemDate >= sevenDaysAgo;
        case '30days':
          const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
          return itemDate >= thirtyDaysAgo;
        case 'custom':
          if (!customDateFrom && !customDateTo) return true;
          const fromDate = customDateFrom ? new Date(customDateFrom) : new Date(0);
          const toDate = customDateTo ? new Date(customDateTo + 'T23:59:59') : new Date();
          return itemDate >= fromDate && itemDate <= toDate;
        default:
          return true;
      }
    }
    
    function applyFilters() {
      const cityFilter = document.getElementById('cityFilter').value;
      const qrFilter = document.getElementById('qrFilter').value;
      const deviceFilter = document.getElementById('deviceFilter').value;
      const duplicateFilter = document.getElementById('duplicateFilter').value;
      
      filteredData = allData.filter(item => {
        if (!filterByDateRange(item)) return false;
        if (cityFilter !== 'all' && item.city !== cityFilter) return false;
        if (qrFilter !== 'all' && item.qr !== qrFilter) return false;
        if (deviceFilter !== 'all' && item.device !== deviceFilter) return false;
        if (duplicateFilter === 'hide' && item.duplicate === 'Yes') return false;
        if (duplicateFilter === 'only' && item.duplicate !== 'Yes') return false;
        return true;
      });
      
      // Update filter status badge
      const filterStatus = document.getElementById('filterStatus');
      const filteredCount = document.getElementById('filteredCount');
      const totalCount = document.getElementById('totalCount');
      
      filteredCount.textContent = filteredData.length;
      totalCount.textContent = allData.length;
      filterStatus.style.display = 'inline-block';
      
      updateMetrics();
      updateCharts();
      updateCityList();
    }
    
    function updateMetrics() {
      const total = filteredData.length;
      const unique = filteredData.filter(d => d.duplicate === 'No').length;
      const mobile = filteredData.filter(d => d.device === 'Mobile').length;
      const duplicates = total - unique;
      
      document.getElementById('totalScans').textContent = total;
      document.getElementById('uniqueScans').textContent = unique;
      document.getElementById('mobileScans').textContent = mobile;
      document.getElementById('duplicateScans').textContent = duplicates;
      
      document.getElementById('uniquePercent').textContent = 
        `${total > 0 ? Math.round((unique / total) * 100) : 0}% of total`;
      document.getElementById('mobilePercent').textContent = 
        `${total > 0 ? Math.round((mobile / total) * 100) : 0}% of total`;
      document.getElementById('duplicatePercent').textContent = 
        `${total > 0 ? Math.round((duplicates / total) * 100) : 0}% of total`;
    }
    
    function updateCharts() {
      // QR Code Chart - Use names instead of IDs
      const qrCounts = {};
      filteredData.forEach(d => {
        const name = d.qrName || d.qr;
        qrCounts[name] = (qrCounts[name] || 0) + 1;
      });
      
      const qrData = {
        labels: Object.keys(qrCounts).sort(),
        datasets: [{
          label: 'Scans',
          data: Object.keys(qrCounts).sort().map(k => qrCounts[k]),
          backgroundColor: ['#667eea', '#f59e0b', '#10b981', '#ef4444']
        }]
      };
      
      if (qrChart) qrChart.destroy();
      const qrCtx = document.getElementById('qrChart').getContext('2d');
      qrChart = new Chart(qrCtx, {
        type: 'bar',
        data: qrData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const total = filteredData.length;
                  const percent = total > 0 ? Math.round((context.parsed.y / total) * 100) : 0;
                  return `${context.parsed.y} scans (${percent}%)`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Device Chart
      const mobile = filteredData.filter(d => d.device === 'Mobile').length;
      const desktop = filteredData.filter(d => d.device === 'Desktop').length;
      
      const deviceData = {
        labels: ['Mobile', 'Desktop'],
        datasets: [{
          data: [mobile, desktop],
          backgroundColor: ['#667eea', '#f59e0b']
        }]
      };
      
      if (deviceChart) deviceChart.destroy();
      const deviceCtx = document.getElementById('deviceChart').getContext('2d');
      deviceChart = new Chart(deviceCtx, {
        type: 'pie',
        data: deviceData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = mobile + desktop;
                  const percent = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                  return `${context.label}: ${context.parsed} (${percent}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    function updateCityList() {
      const cityCounts = {};
      filteredData.forEach(d => {
        if (d.city) cityCounts[d.city] = (cityCounts[d.city] || 0) + 1;
      });
      
      const sortedCities = Object.entries(cityCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      const maxCount = sortedCities[0]?.[1] || 1;
      
      const html = sortedCities.map(([city, count], index) => `
        <div class="city-item">
          <div class="city-rank">${index + 1}</div>
          <div class="city-name">${city}</div>
          <div class="city-count">${count}</div>
          <div class="city-bar">
            <div class="city-bar-fill" style="width: ${(count / maxCount) * 100}%"></div>
          </div>
        </div>
      `).join('');
      
      document.getElementById('cityList').innerHTML = html || '<p style="color: #a0aec0;">No data available</p>';
    }
    
    function clearFilters() {
      document.getElementById('cityFilter').value = 'all';
      document.getElementById('qrFilter').value = 'all';
      document.getElementById('deviceFilter').value = 'all';
      document.getElementById('duplicateFilter').value = 'hide';
      setDateRange('all');
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      customDateFrom = null;
      customDateTo = null;
      applyFilters();
    }
    
    function refreshData() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('dashboard').style.display = 'none';
      loadData();
    }
    
    // Auto-refresh functionality
    function startAutoRefresh() {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
      }
      autoRefreshTimer = setInterval(() => {
        console.log('Auto-refreshing data...');
        loadData();
      }, AUTO_REFRESH_INTERVAL);
    }
    
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const badge = document.getElementById('autoRefreshBadge');
      const btn = document.getElementById('autoRefreshBtn');
      
      if (autoRefreshEnabled) {
        badge.textContent = 'üîÑ Auto-refresh: ON';
        btn.textContent = '‚è∏Ô∏è Pause Auto-Refresh';
        startAutoRefresh();
      } else {
        badge.textContent = '‚è∏Ô∏è Auto-refresh: OFF';
        btn.textContent = '‚ñ∂Ô∏è Resume Auto-Refresh';
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
      }
    }
    
    // Initial load
    loadData();
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
      }
    });
  </script>
</body>
</html>
